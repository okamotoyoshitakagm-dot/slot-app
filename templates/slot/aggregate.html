<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>é›†è¨ˆãƒšãƒ¼ã‚¸</title>
</head>
<body>
  <h1>ğŸ“Š é›†è¨ˆãƒšãƒ¼ã‚¸</h1>

  <!-- æ¡ä»¶ãƒ•ã‚©ãƒ¼ãƒ  -->
  <form method="GET" action="{{ url_for('top.aggregate') }}">
    <fieldset>
      <legend>ğŸ“Œ é›†è¨ˆæ¡ä»¶ã‚’é¸æŠ</legend>

      <!-- å¹´ -->
      <label for="year">å¹´:</label>
      <select name="year" id="year">
        <option value="">--</option>
        {% for y in years %}
          <option value="{{ y }}" {% if y == request.args.get('year') %}selected{% endif %}>{{ y }}</option>
        {% endfor %}
      </select>

      <!-- æœˆ -->
      <label for="month">æœˆ:</label>
      <select name="month" id="month">
        <option value="">--</option>
        {% for m in months %}
          <option value="{{ m }}" {% if m == request.args.get('month') %}selected{% endif %}>{{ m }}</option>
        {% endfor %}
      </select>

      <!-- åº—èˆ—å -->
      <label for="shop">åº—èˆ—:</label>
      <select name="shop" id="shop">
        <option value="">--</option>
        {% for shop in shops %}
          <option value="{{ shop }}" {% if shop == request.args.get('shop') %}selected{% endif %}>{{ shop }}</option>
        {% endfor %}
      </select>

      <!-- ãƒ¦ãƒ¼ã‚¶ãƒ¼å -->
      <label for="username">ãƒ¦ãƒ¼ã‚¶ãƒ¼:</label>
      <select name="username" id="username">
        <option value="">--</option>
        {% for user in usernames %}
          <option value="{{ user }}" {% if user == request.args.get('username') %}selected{% endif %}>{{ user }}</option>
        {% endfor %}
      </select>

      <!-- æ©Ÿç¨®åï¼ˆå¿…é ˆï¼‰ -->
      <label for="machine">æ©Ÿç¨®åï¼ˆå¿…é ˆï¼‰:</label>
      <select name="machine_id" id="machine" required>
        <option value="">-- é¸æŠ --</option>
        {% for id, name in machines %}
          <option value="{{ id }}" {% if id|string == request.args.get('machine_id') %}selected{% endif %}>{{ name }}</option>
        {% endfor %}
      </select>

      <!-- ãƒœã‚¿ãƒ³ -->
      <br><br>
      <button type="submit" id="submit-btn" disabled>é›†è¨ˆã™ã‚‹</button>
    </fieldset>
  </form>

  <!-- JS: æ©Ÿç¨®åé¸æŠæ™‚ã®ã¿ãƒœã‚¿ãƒ³æ´»æ€§åŒ– -->
  <script>
    document.addEventListener("DOMContentLoaded", function () {
      const machineSelect = document.getElementById("machine");
      const submitBtn = document.getElementById("submit-btn");

      function toggleButton() {
        submitBtn.disabled = !machineSelect.value;
      }

      machineSelect.addEventListener("change", toggleButton);
      toggleButton(); // åˆæœŸçŠ¶æ…‹ã®ç¢ºèª
    });
  </script>

  <!-- ğŸ”½ é›†è¨ˆçµæœè¡¨ç¤º -->
  {% if result %}
    <hr>
    <h2>ğŸ“ é›†è¨ˆçµæœ</h2>
    <p>ğŸ“ é›†è¨ˆå¯¾è±¡ä»¶æ•°ï¼š{{ result.count_plays }} ä»¶</p>
    <p>ğŸ° ç·ã‚²ãƒ¼ãƒ æ•°ï¼š{{ result.total_games }} G</p>
    <p>ğŸ’° ç·å·®æšæ•°ï¼š{{ result.total_difference }} æš</p>

    <h3>BBåˆç®—ï¼š{{ result.total_bb }}ï¼ˆ{{ result.total_bb_rate }}ï¼‰</h3>
    <h3>RBåˆç®—ï¼š{{ result.total_rb }}ï¼ˆ{{ result.total_rb_rate }}ï¼‰</h3>

    <table border="1" style="margin-top: 1em;">
      <tr>
        <th>ãƒ•ãƒ©ã‚°</th>
        <th>BBå›æ•°ï¼ˆç¢ºç‡ï¼‰</th>
        <th>RBå›æ•°ï¼ˆç¢ºç‡ï¼‰</th>
      </tr>
      {% for row in result.flags %}
      <tr>
        <td>{{ row.name }}</td>
        <td>{{ row.bb_count }}ï¼ˆ{{ row.bb_rate }}ï¼‰</td>
        <td>{{ row.rb_count }}ï¼ˆ{{ row.rb_rate }}ï¼‰</td>
      </tr>
      {% endfor %}
    </table>
  {% endif %}

  <!-- âœ… ãƒ‡ãƒãƒƒã‚°æƒ…å ±ã®è¡¨ç¤º -->
  {% if debug_info %}
    <hr>
    <h2>ğŸ§ª ãƒ‡ãƒãƒƒã‚°æƒ…å ±</h2>
    <p>é¸æŠä¸­ã® machine_id: {{ debug_info.selected_machine_id }}</p>
    <p>SlotPlay ä»¶æ•°: {{ debug_info.slot_plays_count }}</p>
    <pre>
    {% for p in debug_info.slot_plays %}
      ID: {{ p.id }}, æ—¥ä»˜: {{ p.date }}, ãƒ¦ãƒ¼ã‚¶ãƒ¼: {{ p.username }}, æ©Ÿç¨®ID: {{ p.machine_id }}
    {% endfor %}
    </pre>
  {% endif %}

  <!-- æˆ»ã‚‹ãƒªãƒ³ã‚¯ -->
  <div style="margin-top: 2em;">
    <a href="{{ url_for('top.index') }}">
      <button type="button">ğŸ”™ æˆ»ã‚‹</button>
    </a>
  </div>
</body>
</html>
